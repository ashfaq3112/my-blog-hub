<!DOCTYPE html>
<html lang="en">
<head>
  <title><%= profileUser.name %> - Public Profile</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
  <%- include("partials/navbar") %>

  <div class="container mt-5">
    <div class="card shadow-sm mb-5 p-4 text-center">
      <img src="<%= profileUser.profilepic ? '/images/uploads/' + profileUser.profilepic : '/images/default-profile.png' %>"
           alt="Profile Picture"
           class="profile-pic mb-3 rounded-circle"
           style="width:120px;height:120px;object-fit:cover;">

      <h3><%= profileUser.name %></h3>
      <p><%= profileUser.bio || "No bio available." %></p>
      <p><strong>Email:</strong> <%= profileUser.email %></p>

      <p>
        <!-- Followers trigger -->
        <strong id="followersCount" data-bs-toggle="modal" data-bs-target="#followersModal" style="cursor:pointer;">
          Followers: <%= profileUser.followers.length %>
        </strong> |

        <!-- Following trigger -->
        <strong id="followingCount" data-bs-toggle="modal" data-bs-target="#followingModal" style="cursor:pointer;">
          Following: <%= profileUser.following.length %>
        </strong>
      </p>

      <% if (currentUser._id.toString() !== profileUser._id.toString()) { %>
        <button id="followBtn" data-user-id="<%= profileUser._id %>"
          class="btn <%= currentUser.following.some(u => u._id.toString() === profileUser._id.toString()) ? 'btn-outline-primary' : 'btn-primary' %>">
          <%= currentUser.following.some(u => u._id.toString() === profileUser._id.toString()) ? 'Unfollow' : 'Follow' %>
        </button>
      <% } %>
    </div>

    <!-- Stats Section -->
    <h4 class="mb-3"><%= profileUser.name %>'s Blogs (<%= profileUser.posts.length %>)</h4>
    <div class="row mb-4">
      <div class="col-md-4">
        <div class="card text-center p-3">
          <h5>Total Blogs</h5>
          <h3><%= totalBlogs %></h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center p-3">
          <h5>Total Likes</h5>
          <h3><%= totalLikes %></h3>
        </div>
      </div>
      <div class="col-md-4">
        <div class="card text-center p-3">
          <h5>Most Popular Blog</h5>
          <% if (mostPopularBlog) { %>
            <a href="/blogs/<%= mostPopularBlog._id %>"><%= mostPopularBlog.title %></a>
            <p><%= mostPopularBlog.likes.length %> ❤️</p>
          <% } else { %>
            <p>None</p>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Blog List -->
    <% if (profileUser.posts.length > 0) { %>
      <div class="row">
        <% profileUser.posts.forEach(post => { %>
          <div class="col-md-6 mb-4">
            <div class="card h-100">
              <% if (post.thumbnail) { %>
                <img src="/images/uploads/<%= post.thumbnail %>" class="card-img-top" style="height:180px;object-fit:cover;">
              <% } %>
              <div class="card-body">
                <h5 class="card-title">
                  <a href="/blogs/<%= post._id %>"><%= post.title %></a>
                </h5>
                <% if (post.category) { %>
                  <p><small class="text-muted">Category: <a href="/blogs/category/<%= post.category %>"><%= post.category %></a></small></p>
                <% } %>
                <% if (post.tags && post.tags.length > 0) { %>
                  <p>
                    <% post.tags.forEach(tag => { %>
                      <a href="/blogs/tag/<%= tag %>" class="badge bg-secondary text-decoration-none"><%= tag %></a>
                    <% }) %>
                  </p>
                <% } %>
              </div>
            </div>
          </div>
        <% }) %>
      </div>
    <% } else { %>
      <p class="text-muted">No blogs yet.</p>
    <% } %>
  </div>

  <!-- Followers Modal -->
  <div class="modal fade" id="followersModal" tabindex="-1" aria-labelledby="followersModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Followers</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <% if (profileUser.followers.length > 0) { %>
            <ul class="list-group">
              <% profileUser.followers.forEach(f => { %>
                <li class="list-group-item d-flex align-items-center">
                  <img src="<%= f.profilepic ? '/images/uploads/' + f.profilepic : '/images/default-profile.png' %>"
                       class="rounded-circle me-2" style="width:30px;height:30px;object-fit:cover;">
                  <a href="/user/profile/<%= f._id %>"><%= f.name %></a>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="text-muted">No followers yet.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Following Modal -->
  <div class="modal fade" id="followingModal" tabindex="-1" aria-labelledby="followingModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Following</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <% if (profileUser.following.length > 0) { %>
            <ul class="list-group">
              <% profileUser.following.forEach(f => { %>
                <li class="list-group-item d-flex align-items-center">
                  <img src="<%= f.profilepic ? '/images/uploads/' + f.profilepic : '/images/default-profile.png' %>"
                       class="rounded-circle me-2" style="width:30px;height:30px;object-fit:cover;">
                  <a href="/user/profile/<%= f._id %>"><%= f.name %></a>
                </li>
              <% }) %>
            </ul>
          <% } else { %>
            <p class="text-muted">Not following anyone yet.</p>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <%- include("partials/footer") %>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="/js/follow.js"></script>
</body>
</html>
